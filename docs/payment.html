<!-- ✅ payment.html (Refactored Version Using Original URL Parameter Logic) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Payment – MomentumXLab</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <section class="payment-section">
    <div class="left-panel">
      <h2>Confirm Your Order</h2>
      <div id="details-box">
        <p><strong>EA Model:</strong> <span id="ea-name">—</span></p>
        <p><strong>Package:</strong> <span id="pkg-name">—</span></p>
        <p><strong>Price (USD):</strong> <span id="price-value">—</span></p>
        <p><strong>Status:</strong> Pending</p>
      </div>
      <button id="pay-btn" class="cta-btn">Pay Now</button>
    </div>

    <div class="right-panel">
      <img id="ea-image" src="" alt="EA Preview" />
    </div>
  </section>

  <footer>
    <p>Double check your order before payment.</p>
    <p>© MomentumXLab</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <script>
    const stripe = Stripe("pk_test_51RmdQFFN9S7UG3y8i...");

    const params = new URLSearchParams(location.search);
    const ea     = params.get("plan")?.toLowerCase();
    const pkg    = params.get("package")?.toLowerCase();

    const meta = {
      pro4:  { name: "ApexXAU Intelligent Pro-4",  img: "Pro4_CollectorEdition_whiteBG.png" },
      pro5:  { name: "ApexXAU Intelligent Pro-5",  img: "Pro5_CollectorEdition_whiteBG.png" },
      corex: { name: "ApexXAU Intelligent Core-X", img: "CoreX_PerformanceEdition_whiteBG.png" }
    };

    const pricing = {
      pro4:  { monthly: 19.99, "6m": 106.99, "12m": 193.99 },
      pro5:  { monthly: 39.99, "6m": 213.99, "12m": 388.29 },
      corex: { monthly: 59.99, "6m": 321.09, "12m": 582.07 }
    };

    const nameEl  = document.getElementById("ea-name");
    const pkgEl   = document.getElementById("pkg-name");
    const priceEl = document.getElementById("price-value");
    const imgEl   = document.getElementById("ea-image");
    const payBtn  = document.getElementById("pay-btn");

    function renderPackageDetails() {
      if (!meta[ea] || !pricing[ea]?.[pkg]) {
        document.getElementById("details-box").innerHTML = "<p>⚠️ Invalid order data.</p>";
        payBtn.style.display = "none";
        return;
      }

      nameEl.textContent  = meta[ea].name;
      pkgEl.textContent   = pkg.toUpperCase();
      priceEl.textContent = `$${pricing[ea][pkg].toFixed(2)}`;
      imgEl.src           = meta[ea].img;
      imgEl.alt           = meta[ea].name;
    }

    async function handleStripePayment() {
      payBtn.disabled = true;
      try {
        const res = await fetch("https://us-central1-momentumxlab-37ce2.cloudfunctions.net/createStripeSession", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ plan: ea, package: pkg })
        });

        if (!res.ok) throw new Error(`Stripe error (${res.status})`);
        const { sessionId } = await res.json();
        const { error } = await stripe.redirectToCheckout({ sessionId });
        if (error) throw error;
      } catch (err) {
        Swal.fire("Payment Error", err.message || "Please try again", "error");
        payBtn.disabled = false;
      }
    }

    renderPackageDetails();
    payBtn.addEventListener("click", handleStripePayment);
  </script>
</body>
</html>
