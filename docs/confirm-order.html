<!-- confirm-order.html -->
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Confirm Order</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      max-width: 500px;
      margin: auto;
    }
    label, input, button {
      display: block;
      width: 100%;
      margin-bottom: .75rem;
      font-size: 1rem;
    }
    input[readonly] {
      background: #f2f2f2;
    }
    .checkbox-group {
      display: flex;
      align-items: center;
    }
    .checkbox-group label {
      margin-left: .5rem;
    }
    button {
      padding: .75rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Confirm Your Order</h1>
  <form id="confirm-form">
    <label for="email">Email</label>
    <input type="email" id="email" readonly />

    <label for="planName">EA รุ่น</label>
    <input type="text" id="planName" readonly />

    <label for="pkg">Package</label>
    <input type="text" id="pkg" readonly />

    <label for="price">สรุปราคา (USD)</label>
    <input type="text" id="price" readonly />

    <label for="expiry">วันหมดอายุ</label>
    <input type="text" id="expiry" readonly />

    <label for="mt5acc">MT5 Account</label>
    <input type="text" id="mt5acc" required />

    <label for="broker">Broker Server</label>
    <input type="text" id="broker" required />

    <div class="checkbox-group">
      <input type="checkbox" id="agree" />
      <label for="agree">ยอมรับเงื่อนไขและข้อกำหนด</label>
    </div>

    <button type="submit">Confirm</button>
  </form>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    // 1. Firebase config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      // ... ของคุณจาก Firebase console
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db   = firebase.firestore();

    // 2. แผน ราค และระยะเวลา
    const planNames = {
      pro3: 'EA Pro 3',
      pro4: 'EA Pro 4',
      core: 'EA Core X'
    };
    const priceMap = {
      monthly: 100,
      '6m': 540,
      '12m': 1000
    };
    const monthMap = {
      monthly: 1,
      '6m': 6,
      '12m': 12
    };

    // 3. ตรวจสอบล็อกอิน
    auth.onAuthStateChanged(user => {
      if (!user) {
        Swal.fire({
          icon: 'warning',
          title: 'กรุณาเข้าสู่ระบบ',
          text: 'คุณต้องล็อกอินก่อนดำเนินการ',
          confirmButtonText: 'ไปยังหน้าเข้าสู่ระบบ'
        }).then(() => {
          const redirect = encodeURIComponent(window.location.href);
          window.location.href = `login.html?redirect=${redirect}`;
        });
      } else {
        initForm(user);
      }
    });

    // 4. ดึง params, เติมฟอร์ม และตั้ง handler
    function initForm(user) {
      const qs      = new URLSearchParams(window.location.search);
      const planKey = qs.get('plan')    || '';
      const pkgKey  = qs.get('package') || '';

      // เติมค่าฟอร์ม
      document.getElementById('email').value     = user.email;
      document.getElementById('planName').value = planNames[planKey] || planKey;
      document.getElementById('pkg').value       = pkgKey;
      const priceVal = priceMap[pkgKey] || 0;
      document.getElementById('price').value     = priceVal + ' USD';

      // คำนวณวันหมดอายุ
      const expiry = new Date();
      expiry.setMonth(expiry.getMonth() + (monthMap[pkgKey] || 0));
      document.getElementById('expiry').value = expiry.toLocaleDateString('th-TH');

      // 5. สร้าง order เมื่อ submit
      document.getElementById('confirm-form').addEventListener('submit', async e => {
        e.preventDefault();

        if (!document.getElementById('agree').checked) {
          return Swal.fire('กรุณายอมรับเงื่อนไขก่อน');
        }
        const mt5Acc = document.getElementById('mt5acc').value.trim();
        const broker = document.getElementById('broker').value.trim();
        if (!mt5Acc || !broker) {
          return Swal.fire('กรุณากรอก MT5 Account และ Broker Server ให้ครบ');
        }

        try {
          await db.collection('orders').add({
            uid:       user.uid,
            email:     user.email,
            plan:      planKey,
            package:   pkgKey,
            price:     priceVal,
            expiry:    firebase.firestore.Timestamp.fromDate(expiry),
            mt5Acc,
            broker,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });

          Swal.fire('สำเร็จ', 'สร้างคำสั่งซื้อเรียบร้อย', 'success')
            .then(() => window.location.href = 'dashboard.html');
        } catch (err) {
          console.error(err);
          Swal.fire('เกิดข้อผิดพลาด', err.message, 'error');
        }
      });
    }
  </script>
</body>
</html>
