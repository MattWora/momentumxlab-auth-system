<!DOCTYPE html>
<html lang="th">
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Confirm Your Order – MomentumXLab</title>
  <link rel="stylesheet" href="style.css"/>
  <title>Confirm Your Order</title>
  <!-- Google Font (replace with your theme’s font if different) -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* Global resets and theme font */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
      background: #f5f5f5;
      color: #333;
    }

    /* Layout */
    .pro4-section {
      display: flex;
      flex-wrap: wrap;
      max-width: 1200px;
      margin: 2rem auto;
      gap: 2rem;
    }

    .left-content,
    .right-content {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 2rem;
      flex: 1 1 300px;
    }

    /* Logo styling */
    .left-content .logo {
      width: 15%;
      display: block;
      margin-bottom: 1rem;
    }

    /* Section header */
    .left-content h2 {
      font-size: 2rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    /* Form styling */
    .order-form .form-group {
      margin-bottom: 1rem;
    }

    .order-form label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .order-form input {
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fafafa;
    }

    .order-form button.submit-btn {
      margin-top: 1.5rem;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      color: #fff;
      background: #007bff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .order-form button.submit-btn:hover {
      background: #0056b3;
    }

    /* Order summary styling */
    .order-summary h3 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    .order-summary ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .order-summary li {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      font-weight: 500;
    }

    .order-summary li strong {
      font-size: 1.1rem;
    }
  </style>
</head>
<body>

  <section class="pro4-section">
    <!-- Left column: order form -->
    <div class="left-content">
      <img
        src="momentumxlab-logo.png"
        alt="MomentumXLab Logo"
        class="logo"
      />
      <h2>Confirm Your Order</h2>

      <form id="order-form" class="order-form">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="email" readonly required/>
        </div>
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="fullName" required/>
        </div>
        <div class="form-group">
          <label>Phone Number</label>
          <input type="tel" id="phone" required/>
        </div>
        <div class="form-group">
          <label>MT5 Account Number</label>
          <input type="text" id="mt5Account" required pattern="\d+"/>
        </div>
        <div class="form-group">
          <label>Broker Server</label>
          <input type="text" id="brokerServer" required/>
        </div>
        <div class="form-group">
          <label>EA ชื่อ</label>
          <input type="text" id="planName" readonly/>
        </div>
        <div class="form-group">
          <label>Package</label>
          <input type="text" id="pkg" readonly/>
          <label for="email">Email</label>
          <input
            type="email"
            id="email"
            name="email"
            readonly
            required
            value="testuser@momentumxlab.com"
          />
        </div>

        <div class="form-group">
          <label>Price (USD)</label>
          <input type="text" id="price" readonly/>
          <label for="plan">Plan</label>
          <input
            type="text"
            id="plan"
            name="plan"
            readonly
            value="ApexXAU Intelligent Pro-4 (6 Months)"
          />
        </div>

        <div class="form-group">
          <label>Expiry Date</label>
          <input type="text" id="expiry" readonly required/>
          <label for="price">Price</label>
          <input
            type="text"
            id="price"
            name="price"
            readonly
            value="$106.99 USD"
          />
        </div>
        <div class="form-group checkbox-group">
          <input type="checkbox" id="agree"/>
          <label for="agree">
            I acknowledge the terms and certify that the above information is accurate.
          </label>
        </div>
        <button class="cta-btn" type="submit" id="btn-confirm" disabled>
          Confirm and Generate License

        <button type="submit" class="submit-btn">
          Confirm Purchase
        </button>
        <a id="download-btn" href="#" class="cta-btn" style="display:none;">
          Download
        </a>
      </form>
    </div>

    <!-- Right column: summary -->
    <div class="right-content">
      <div class="mockup-wrapper">
        <img id="product-image" src="" alt="Product Box"/>
        <p class="edition custom">
          Your license will activate upon payment and remain valid until its expiration date.
        </p>
      <div class="order-summary">
        <h3>Order Summary</h3>
        <ul>
          <li><span>Product</span><span>ApexXAU Intelligent Pro-4 (6 Months)</span></li>
          <li><span>Price</span><span>$106.99 USD</span></li>
          <li><span>Tax</span><span>$0.00</span></li>
          <li><strong>Total</strong><strong>$106.99 USD</strong></li>
        </ul>
      </div>
    </div>
  </section>

  <footer class="footer-section">
    <div class="footer-text">
      <p>By submitting this form, you acknowledge the terms and certify accuracy of the information.</p>
      <p class="copyright">© 2025 MomentumXLab. All rights reserved.</p>
    </div>
  </footer>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Firebase Compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDeUaFNrqo5DKQWuWz1kiru1MVOSuRHDmk",
      authDomain: "momentumxlab-37ce2.firebaseapp.com",
      projectId: "momentumxlab-37ce2"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // product data
    const planNames = {
      pro4: "ApexXAU Intelligent Pro-4",
      pro5: "ApexXAU Intelligent Pro-5",
      corex: "ApexXAU Intelligent Core-X"
    };
    const planImages = {
      pro4: "Pro4_CollectorEdition_whiteBG.png",
      pro5: "Pro5_CollectorEdition_whiteBG.png",
      corex: "CoreX_PerformanceEdition_whiteBG.png"
    };
    const priceMap = {
      pro4: { monthly: 19.99, "6m": 106.99, "12m": 193.99 },
      pro5: { monthly: 39.99, "6m": 213.99, "12m": 388.29 },
      corex: { monthly: 59.99, "6m": 321.09, "12m": 582.07 }
    };
    const monthMap = { monthly: 1, "6m": 6, "12m": 12 };

    document.addEventListener("DOMContentLoaded", () => {
      auth.onAuthStateChanged(user => {
        if (!user) {
          Swal.fire({
            icon: "warning",
            title: "กรุณาเข้าสู่ระบบ",
            text: "ต้องเข้าสู่ระบบก่อนดำเนินการ",
            confirmButtonText: "ไปที่หน้าล็อกอิน"
          }).then(() => {
            const redirect = encodeURIComponent(window.location.href);
            location.href = `login.html?redirect=${redirect}`;
          });
        } else {
          initForm(user);
        }
      });
    });

    function initForm(user) {
      const qs = new URLSearchParams(location.search);
      const planKey = (qs.get("plan") || "").toLowerCase();
      const pkgKey  = (qs.get("package") || "").toLowerCase();
      const status  = (qs.get("status") || "").toLowerCase(); // <— new

      // เติมข้อมูลลงฟอร์ม
      document.getElementById("email").value    = user.email || "";
      document.getElementById("planName").value = planNames[planKey] || planKey;
      document.getElementById("pkg").value      = pkgKey;
      const priceVal = ((priceMap[planKey] || {})[pkgKey]) || 0;
      document.getElementById("price").value    = `$${priceVal.toFixed(2)}`;

      // คำนวณวันหมดอายุ
      const expDate = new Date();
      expDate.setMonth(expDate.getMonth() + (monthMap[pkgKey] || 0));
      const dd   = String(expDate.getDate()).padStart(2, "0");
      const mm   = String(expDate.getMonth() + 1).padStart(2, "0");
      const yyyy = expDate.getFullYear();
      document.getElementById("expiry").value = `${dd}/${mm}/${yyyy}`;

      // แสดงภาพ mockup
      const img = document.getElementById("product-image");
      img.src = planImages[planKey] || "";
      img.alt = planNames[planKey] || "";

      // เช็ค checkbox เพื่อปลดล็อกปุ่ม Confirm
      document.getElementById("agree")
        .addEventListener("change", e => {
          document.getElementById("btn-confirm").disabled = !e.target.checked;
        });

      // Submit handler
      document.getElementById("order-form")
        .addEventListener("submit", async e => {
          e.preventDefault();

          // 1) ถ้ายังไม่จ่ายเงิน → พาไป payment.html
          if (status !== "paid") {
            window.location.href = 
              `payment.html?plan=${planKey}&package=${pkgKey}`;
            return;
          }

          // 2) จ่ายแล้ว → สร้าง order + license
          if (!auth.currentUser) return;
          if (!document.getElementById("agree").checked) {
            return Swal.fire("กรุณายอมรับเงื่อนไขก่อน");
          }

          const mt5    = document.getElementById("mt5Account").value.trim();
          const broker = document.getElementById("brokerServer").value.trim();
          if (!mt5 || !broker) {
            return Swal.fire(
              "กรุณากรอก MT5 Account และ Broker Server ให้ครบ"
            );
          }

          try {
            await db.collection("orders").add({
              uid:           user.uid,
              email:         user.email,
              plan:          planKey,
              package:       pkgKey,
              price:         priceVal,
              expiry:        firebase.firestore.Timestamp.fromDate(expDate),
              mt5Account:    mt5,
              brokerServer:  broker,
              createdAt:     firebase.firestore.FieldValue.serverTimestamp()
            });
            Swal.fire(
              "License Activated!",
              "Your license is confirmed.",
              "success"
            ).then(() => {
              document.getElementById("download-btn").style.display = "inline-block";
              document.getElementById("btn-confirm").disabled = true;
            });
          } catch (err) {
            Swal.fire("Error", err.message, "error");
          }
        });
    }
  </script>
</body>
</html>
