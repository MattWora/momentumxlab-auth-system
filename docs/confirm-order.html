<!-- confirm-order.html -->
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Confirm Your Order</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      max-width: 480px;
      margin: auto;
    }
    label, input, button {
      display: block;
      width: 100%;
      margin-bottom: .75rem;
      font-size: 1rem;
    }
    input[readonly] {
      background: #f2f2f2;
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }
    .checkbox-group label {
      margin-left: .5rem;
    }
    button {
      padding: .75rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Confirm Your Order</h1>
  <form id="confirm-form">
    <label for="email">Email</label>
    <input type="email" id="email" readonly />

    <label for="planName">EA รุ่น</label>
    <input type="text" id="planName" readonly />

    <label for="pkg">Package</label>
    <input type="text" id="pkg" readonly />

    <label for="price">สรุปราคา (USD)</label>
    <input type="text" id="price" readonly />

    <label for="expiry">วันหมดอายุ</label>
    <input type="text" id="expiry" readonly />

    <label for="mt5acc">MT5 Account</label>
    <input type="text" id="mt5acc" required />

    <label for="broker">Broker Server</label>
    <input type="text" id="broker" required />

    <div class="checkbox-group">
      <input type="checkbox" id="agree" />
      <label for="agree">ยอมรับเงื่อนไขและข้อกำหนด</label>
    </div>

    <button type="submit">Confirm</button>
  </form>

  <!-- Firebase Compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    // 1. Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDeUaFNrqo5DKQWuWz1kiru1MVOSuRHDmk",
      authDomain: "momentumxlab-37ce2.firebaseapp.com",
      projectId: "momentumxlab-37ce2"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db   = firebase.firestore();

    // 2. Pricing & plans
    const planNames = {
      pro4: "ApexXAU Intelligent Pro-4",
      pro5: "ApexXAU Intelligent Pro-5",
      corex: "ApexXAU Intelligent Core-X"
    };
    const priceMap = {
      pro4: { monthly: 19.99, "6m": 106.99, "12m": 193.99 },
      pro5: { monthly: 39.99, "6m": 213.99, "12m": 388.29 },
      corex: { monthly: 49.99, "6m": 267.49, "12m": 485.42 }
    };
    const monthMap = { monthly: 1, "6m": 6, "12m": 12 };

    // 3. Check login once on load
    auth.onAuthStateChanged(user => {
      if (user) {
        initForm(user);
      } else {
        Swal.fire({
          icon: "warning",
          title: "กรุณาเข้าสู่ระบบ",
          text: "คุณต้องล็อกอินก่อนดำเนินการ",
          confirmButtonText: "ไปหน้าเข้าสู่ระบบ"
        }).then(() => {
          const backTo = encodeURIComponent(window.location.href);
          window.location.href = `login.html?redirect=${backTo}`;
        });
      }
    });

    // 4. Fill form and wire up submit
    function initForm(user) {
      const qs      = new URLSearchParams(window.location.search);
      const planKey = (qs.get("plan") || "").toLowerCase();
      const pkgKey  = (qs.get("package") || "").toLowerCase();

      // fill auth data
      document.getElementById("email").value    = user.email || "";
      document.getElementById("planName").value = planNames[planKey] || planKey;
      document.getElementById("pkg").value      = pkgKey;

      // price + expiry
      const priceVal = (priceMap[planKey] || {})[pkgKey] || 0;
      document.getElementById("price").value = `$${priceVal.toFixed(2)}`;

      const expDate = new Date();
      expDate.setMonth(expDate.getMonth() + (monthMap[pkgKey] || 0));
      document.getElementById("expiry").value = expDate.toLocaleDateString("th-TH");

      // submit handler
      document.getElementById("confirm-form").addEventListener("submit", async e => {
        e.preventDefault();
        if (!auth.currentUser) {
          return Swal.fire("คุณยังไม่ได้ล็อกอิน", "", "warning");
        }
        if (!document.getElementById("agree").checked) {
          return Swal.fire("กรุณายอมรับเงื่อนไขก่อน");
        }
        const mt5   = document.getElementById("mt5acc").value.trim();
        const broker= document.getElementById("broker").value.trim();
        if (!mt5 || !broker) {
          return Swal.fire("กรุณากรอก MT5 Account และ Broker Server ให้ครบ");
        }

        try {
          await db.collection("orders").add({
            uid:       user.uid,
            email:     user.email,
            plan:      planKey,
            package:   pkgKey,
            price:     priceVal,
            expiry:    firebase.firestore.Timestamp.fromDate(expDate),
            mt5Account:mt5,
            brokerServer: broker,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          Swal.fire("สำเร็จ", "สร้างคำสั่งซื้อเรียบร้อย", "success")
            .then(() => window.location.href = "dashboard.html");
        } catch (err) {
          console.error(err);
          Swal.fire("เกิดข้อผิดพลาด", err.message, "error");
        }
      });
    }
  </script>
</body>
</html>
