<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Confirm Your Order â€“ DEBUG</title>
</head>
<body>
  <h2>DEBUG: Confirm Your Order</h2>
  <form id="order-form">
    <input id="email" placeholder="Email (readonly)" readonly />
    <input id="fullName" placeholder="Full Name" />
    <input id="phone" placeholder="Phone" />
    <input id="mt5Account" placeholder="MT5 Account" />
    <input id="brokerServer" placeholder="Broker Server" />
    <input id="package" placeholder="Package" readonly />
    <input id="price" placeholder="Price" readonly />
    <input id="expiry" type="date" readonly />
    <input type="checkbox" id="agree" /> <label for="agree">Agree</label>
    <button id="btn-confirm" disabled>Confirm</button>
  </form>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Firebase Compat -->
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>

  <script>
    console.log("ðŸ‘‰ Script Loaded");
    const firebaseConfig = {
      apiKey: "AIzaSyDeUaFNrqo5DKQWuWz1kiru1MVOSuRHDmk", 
      authDomain: "momentumxlab-37ce2.firebaseapp.com", 
      projectId: "momentumxlab-37ce2"
    };

    console.log("before init, firebase =", window.firebase);
    firebase.initializeApp(firebaseConfig);
    console.log("after init, firebase.apps =", firebase.apps);

    const auth = firebase.auth();
    const firestore = firebase.firestore();
    console.log("auth, firestore ready:", auth, firestore);

    document.addEventListener("DOMContentLoaded", () => {
      console.log("DOM ready. URLSearchParams =", location.search);
      const params = new URLSearchParams(location.search);
      const plan = params.get("plan");
      const pkg  = params.get("package");
      console.log("plan, package =", plan, pkg);
      // -- à¸Šà¸¸à¸”à¹à¸œà¸™à¸£à¸²à¸„à¸²à¸•à¸²à¸¡à¹€à¸”à¸´à¸¡ --

      document.getElementById("agree").addEventListener("change", e => {
        console.log("checkbox changed:", e.target.checked);
        document.getElementById("btn-confirm").disabled = !e.target.checked;
      });

      console.log("â†’ calling onAuthStateChanged");
      auth.onAuthStateChanged(async user => {
        console.log("onAuthStateChanged â†’ user =", user);
        if (!user) {
          console.warn("no user, redirecting to login");
          //location.href = `login.html?redirect=${encodeURIComponent(location.href)}`;
          return;
        }

        console.log("user.uid =", user.uid, ", user.email =", user.email);
        document.getElementById("email").value = user.email;

        const userRef = firestore.collection("users").doc(user.uid);
        console.log("â†’ fetching user doc");
        let snapshot;
        try {
          snapshot = await userRef.get();
          console.log("userDoc snapshot:", snapshot.exists, snapshot.data());
        } catch (err) {
          console.error("âŒ error fetching userDoc:", err);
        }

        if (!snapshot.exists) {
          console.log("doc not exists, creating one");
          try {
            await userRef.set({ fullName: "", phone: "", createdAt: Date.now() });
            snapshot = await userRef.get();
            console.log("new doc data:", snapshot.data());
          } catch (err) {
            console.error("âŒ error creating userDoc:", err);
          }
        }

        // fill form
        const data = snapshot.data() || {};
        document.getElementById("fullName").value = data.fullName || "";
        document.getElementById("phone").value    = data.phone    || "";

        document.getElementById("order-form").addEventListener("submit", async e => {
          e.preventDefault();
          console.log("form submit, status param:", params.get("status"));
          // ... save order logic ...
        });
      });
    });
  </script>
</body>
</html>
