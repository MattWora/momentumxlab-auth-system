<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Confirm Your Order – MomentumXLab</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <section class="pro4-section">
    <div class="left-content">
      <h2>Confirm Your Order</h2>
      <form id="order-form" class="order-form">
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="fullName" required>
        </div>
        <div class="form-group">
          <label>Phone Number</label>
          <input type="tel" id="phone" required>
        </div>
        <div class="form-group">
          <label>MT5 Account Number</label>
          <input type="text" id="mt5Account" required pattern="\\d+">
        </div>
        <div class="form-group">
          <label>Broker Server</label>
          <input type="text" id="brokerServer" required>
        </div>
        <div class="form-group">
          <label>Package</label>
          <input type="text" id="pkg" readonly>
        </div>
        <div class="form-group">
          <label>Expiry Date</label>
          <input type="text" id="expiry" readonly required>
        </div>
        <div class="form-group checkbox-group">
          <input type="checkbox" id="agree">
          <label for="agree"> ยอมรับข้อกำหนดและรับรองว่าข้อมูลข้างต้นถูกต้อง </label>
        </div>
        <button class="cta-btn" type="submit" id="btn-confirm" disabled>
          Confirm and Generate License
        </button>
        <a id="download-btn" href="#" class="cta-btn" style="display:none;">
          Download
        </a>
      </form>
    </div>
    <div class="right-content">
      <div class="mockup-wrapper">
        <img id="product-image" src="" alt="Product Box">
        <p class="edition custom">
          Your license will activate upon payment and remain valid until its expiration date.
        </p>
      </div>
    </div>
  </section>

  <footer class="footer-section">
    <div class="footer-text">
      <p>By submitting this form, you acknowledge the terms and certify accuracy of the information.</p>
      <p class="copyright">© 2025 MomentumXLab. All rights reserved.</p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDeUaFNrqo5DKQWuWz1kiru1MVOSuRHDmk",
      authDomain: "momentumxlab-37ce2.firebaseapp.com",
      projectId: "momentumxlab-37ce2"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const planImages = {
      pro4: "Pro4_CollectorEdition_whiteBG.png",
      pro5: "Pro5_CollectorEdition_whiteBG.png",
      corex: "CoreX_PerformanceEdition_whiteBG.png"
    };

    const monthMap = { monthly: 1, "6m": 6, "12m": 12 };

    document.addEventListener("DOMContentLoaded", () => {
      auth.onAuthStateChanged(user => {
        if (!user) {
          Swal.fire({
            icon: "warning",
            title: "กรุณาเข้าสู่ระบบ",
            text: "ต้องเข้าสู่ระบบก่อนดำเนินการ",
            confirmButtonText: "ไปที่หน้าล็อกอิน"
          }).then(() => {
            const redirect = encodeURIComponent(window.location.href);
            location.href = `login.html?redirect=${redirect}`;
          });
        } else {
          initForm(user);
        }
      });
    });

    function initForm(user) {
      const qs = new URLSearchParams(location.search);
      const planKey = (qs.get("plan") || "").toLowerCase();
      const pkgKey = (qs.get("package") || "").toLowerCase();

      document.getElementById("pkg").value = pkgKey;

      const expDate = new Date();
      expDate.setMonth(expDate.getMonth() + (monthMap[pkgKey] || 0));
      const dd = String(expDate.getDate()).padStart(2, "0");
      const mm = String(expDate.getMonth() + 1).padStart(2, "0");
      const yyyy = expDate.getFullYear();
      document.getElementById("expiry").value = `${dd}/${mm}/${yyyy}`;

      const img = document.getElementById("product-image");
      img.src = planImages[planKey] || "";
      img.alt = planKey;

      document.getElementById("agree").addEventListener("change", e => {
        document.getElementById("btn-confirm").disabled = !e.target.checked;
      });

      document.getElementById("order-form").addEventListener("submit", async e => {
        e.preventDefault();
        if (!auth.currentUser) return;
        if (!document.getElementById("agree").checked) {
          return Swal.fire("กรุณายอมรับเงื่อนไขก่อน");
        }

        const mt5 = document.getElementById("mt5Account").value.trim();
        const broker = document.getElementById("brokerServer").value.trim();
        if (!mt5 || !broker) {
          return Swal.fire("กรอก MT5 Account และ Broker Server ให้ครบ");
        }

        try {
          await db.collection("orders").add({
            uid: user.uid,
            email: user.email,
            plan: planKey,
            package: pkgKey,
            expiry: firebase.firestore.Timestamp.fromDate(expDate),
            mt5Account: mt5,
            brokerServer: broker,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });

          Swal.fire("License Activated!", "Your license is confirmed.", "success").then(() => {
            document.getElementById("download-btn").style.display = "inline-block";
            document.getElementById("btn-confirm").disabled = true;
          });
        } catch (err) {
          Swal.fire("Error", err.message, "error");
        }
      });
    }
  </script>
</body>
</html>
