<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Confirm Your Order – MomentumXLab</title>
  <link rel="icon" href="favicon.ico"/>
  <link
    href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <h1>Confirm Your Order</h1>

  <!-- License Summary Section -->
  <div id="license-summary" style="margin-bottom:24px; font-size:16px;"></div>

  <!-- User Order Form -->
  <form id="order-form">
    <label for="email">Your Email</label>
    <input type="email" id="email" name="email" readonly required/>

    <label for="fullName">Full Name</label>
    <input type="text" id="fullName" name="fullName" placeholder="John Doe" required/>

    <label for="phone">Phone Number</label>
    <input type="tel" id="phone" name="phone" placeholder="+66 812345678" required/>

    <label for="mt5Account">MT5 Account Number</label>
    <input type="text" id="mt5Account" name="mt5Account" placeholder="12345678" pattern="\d+" required/>

    <label for="brokerServer">Broker Server</label>
    <select id="brokerServer" name="brokerServer" required>
      <option value="">-- Select Server --</option>
      <option value="Exness-Real1">Exness-Real1</option>
      <option value="Exness-Real2">Exness-Real2</option>
      <option value="XM-MT5Live">XM-MT5Live</option>
      <option value="FBS-Real">FBS-Real</option>
      <option value="ICMarkets-Live">ICMarkets-Live</option>
    </select>
    <p class="note">
      Your license will be valid only for the selected account and server.
    </p>

    <div style="margin:20px 0;">
      <input type="checkbox" id="agree"/>
      <label for="agree">
        I acknowledge the terms and certify that the above information is accurate.
      </label>
    </div>

    <button type="submit" id="btn-confirm" disabled>
      Confirm and Generate License
    </button>

    <p id="status"></p>
  </form>

  <!-- SDKs -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <script>
    const firebaseConfig = {
      apiKey:            "AIzaSyDeUaFNrqo5DKQWuWz1kiru1MVOSuRHDmk",
      authDomain:        "momentumxlab-37ce2.firebaseapp.com",
      projectId:         "momentumxlab-37ce2",
      storageBucket:     "momentumxlab-37ce2.appspot.com",
      messagingSenderId: "694369524772",
      appId:             "1:694369524772:web:60961d9548591c1ff3ccb1"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // Get plan details from URL
    const params = new URLSearchParams(location.search);
    const planKey = params.get('plan') || 'monthly';

    const pkgMap = {
      monthly: { name:'Pro-4 Monthly',  price:19.99,  months:1 },
      '6m':    { name:'Pro-4 6-Month',  price:106.99, months:6 },
      annual:  { name:'Pro-4 Annual',   price:193.99, months:12 }
    };

    const pkg = pkgMap[planKey];
    const startDate = new Date();
    const endDate   = new Date();
    endDate.setMonth(endDate.getMonth() + pkg.months);

    const startStr = startDate.toISOString().split('T')[0];
    const endStr   = endDate.toISOString().split('T')[0];

    document.getElementById('license-summary').innerHTML = `
      <ul style="list-style:none; padding:0;">
        <li><strong>Plan:</strong> ${pkg.name}</li>
        <li><strong>Price:</strong> $${pkg.price.toFixed(2)}</li>
        <li><strong>License Period:</strong> ${startStr} → ${endStr}</li>
      </ul>
    `;

    // Fill email from Firebase Auth
    const emailInput = document.getElementById('email');
    auth.onAuthStateChanged(user => {
      if (user) {
        emailInput.value = user.email;
      }
    });

    // Enable button when checkbox is ticked
    const agreeCb = document.getElementById('agree');
    const btnConfirm = document.getElementById('btn-confirm');
    agreeCb.addEventListener('change', () => {
      btnConfirm.disabled = !agreeCb.checked;
    });

    // Handle form submission
    document.getElementById('order-form').addEventListener('submit', async e => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) {
        await Swal.fire('Session Expired', 'Please login again to proceed.', 'warning');
        const back = encodeURIComponent(location.href);
        return window.location.href = `login.html?redirect=${back}`;
      }

      const form = e.target;
      const data = {
        email:      user.email,
        fullName:   form.fullName.value.trim(),
        phone:      form.phone.value.trim(),
        mt5Account: form.mt5Account.value.trim(),
        brokerServer: form.brokerServer.value,
        plan:       planKey,
        licenseStart: startStr,
        licenseEnd:   endStr
      };

      console.log('→ License data:', data);
      // TODO: send `data` to backend/Cloud Function for license generation

      await Swal.fire('Confirmed','Your license request is being processed','success');
    });
  </script>
</body>
</html>
