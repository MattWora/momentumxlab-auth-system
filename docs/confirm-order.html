<!DOCTYPE html>
<html lang="en">
<head>
  
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Confirm Your Order – MomentumXLab</title>
  <link rel="stylesheet" href="style.css" />
  
</head>
<body>
  
  <h2>Confirm Your Order</h2>
  <form id="order-form">
    <input id="email" placeholder="Email (readonly)" readonly />
    <input id="fullName" placeholder="Full Name" />
    <input id="phone" placeholder="Phone" />
    <input id="mt5Account" placeholder="MT5 Account" />
    <input id="brokerServer" placeholder="Broker Server" />
    <input id="package" placeholder="Package" readonly />
    <input id="price" placeholder="Price" readonly />
    <input id="expiry" type="date" placeholder="Expiry Date" readonly />
    
    <div class="checkbox-group">
      <input type="checkbox" id="agree" />
      <label for="agree">I agree to the terms and conditions</label>
    </div>
    
    <button id="btn-confirm" disabled>Confirm</button>
  </form>
  
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Firebase Compat -->
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>
  
  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDeUaFNrqo5DKQWuWz1kiru1MVOSuRHDmk",
      authDomain: "momentumxlab-37ce2.firebaseapp.com",
      projectId: "momentumxlab-37ce2"
    };
    firebase.initializeApp(firebaseConfig);
    
    const auth = firebase.auth();
    const firestore = firebase.firestore();
    
    document.addEventListener("DOMContentLoaded", () => {
      // 1. Parse URL params
      const params = new URLSearchParams(location.search);
      const plan = params.get("plan") || "";
      const pkg  = params.get("package") || "";
  
      // 2. Display package code
      document.getElementById("package").value = pkg;
  
      // 3. Map package → price
      const packagePrices = {
        pro4: { "1m": 500,  "6m": 2500, "12m": 4500 },
        pro5: { "1m": 600,  "6m": 3000, "12m": 5500 }
      };
      const price = (
        packagePrices[plan] &&
        packagePrices[plan][pkg]
      ) || 0;
      document.getElementById("price").value = price;
  
      // 4. Compute expiry date
      const months = parseInt(pkg, 10);
      let expiryStr = "";
      if (!isNaN(months)) {
        const expDate = new Date();
        expDate.setMonth(expDate.getMonth() + months);
        expiryStr = expDate.toISOString().split("T")[0];
      }
      document.getElementById("expiry").value = expiryStr;
  
      // 5. Enable button when checkbox checked
      document.getElementById("agree").addEventListener("change", e => {
        document.getElementById("btn-confirm").disabled = !e.target.checked;
      });
  
      // 6. Fill user profile fields with proper fallbacks
      auth.onAuthStateChanged(async user => {
        if (!user) {
          location.href = `login.html?redirect=${encodeURIComponent(location.href)}`;
          return;
        }
  
        // Email always from auth
        document.getElementById("email").value = user.email || "";
  
        // Fetch or create user doc
        const userRef  = firestore.collection("users").doc(user.uid);
        let snapshot   = await userRef.get();
  
        if (!snapshot.exists) {
          await userRef.set({
            fullName: "",
            phone: "",
            createdAt: Date.now()
          });
          snapshot = await userRef.get();
        }
  
        const data = snapshot.data() || {};
        // Use firestore fullName, fallback to auth.displayName, then empty string
        const fullName = data.fullName ?? user.displayName ?? "";
        const phone    = data.phone    ?? "";
  
        document.getElementById("fullName").value = fullName;
        document.getElementById("phone").value    = phone;
      });
  
      // 7. Handle form submission
      document.getElementById("order-form").addEventListener("submit", async e => {
        e.preventDefault();
  
        const user = auth.currentUser;
        if (!user) {
          Swal.fire("Please log in first", "", "warning");
          return;
        }
  
        const orderData = {
          userId:       user.uid,
          email:        user.email,
          fullName:     document.getElementById("fullName").value,
          phone:        document.getElementById("phone").value,
          mt5Account:   document.getElementById("mt5Account").value,
          brokerServer: document.getElementById("brokerServer").value,
          plan,
          package:      pkg,
          price,
          expiry:       new Date(document.getElementById("expiry").value).getTime(),
          status:       "pending",
          createdAt:    Date.now()
        };
  
        try {
          await firestore.collection("orders").add(orderData);
          Swal.fire("Order Confirmed", "Your order has been placed.", "success")
            .then(() => location.href = "dashboard.html");
        } catch (err) {
          Swal.fire("Error", err.message, "error");
        }
      });
    });
  </script>
  
</body>
</html>
```
